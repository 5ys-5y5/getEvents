c. 가치 평가

    1. 개요  
        - getValuation 엔드포인트를 실행하면, 먼저 getEvent 혹은 getEventLatest를 통해 docs/getEventCache.json 에 저장된 ticker 목록을 읽어온다.
            - docs/getEventCache.json.meta.request 에 기록된 startDate, endDate, fromDate, toDate 정보는 로깅/메타데이터 용도로만 사용하며, 가치 평가 계산 로직에는 직접 개입하지 않는다.
        - 이후 docs/ApiList.json 및 docs/evMethod.json 을 참조하여, 각 ticker 에 대해 아래 두 가지 방식의 가치 평가를 순차적으로 수행한다.
            - 방식1: 기업 공시 지표·매출 기반 정량(Quantitative) 가치 평가
            - 방식2: 컨센서스·애널리스트 기반 정성(Qualitative) 가치 평가
        - getValuation 은 각 ticker 에 대해 두 방식의 계산 결과를 하나의 평가 객체로 병합해 반환한다.

    2. 공통 aggregation 규칙 (docs/evMethod.json / aggregations)  
        - ttmFromQuarterSumOrScaled  
            - 입력: number[] (income-statement quarter&limit=4 응답에서 특정 항목 값 배열)  
            - 규칙:
                - 값이 4개면 합계 = TTM(최근 4분기 합산)  
                - 값이 1~3개면 (합계 / 개수) × 4 로 1년치(TTM)를 근사  
                - 값이 0개면 null  
            - 사용 예: revenueTTM, netIncomeTTM, ebitdaTTM 등 생성
        - avgFromQuarter  
            - 입력: number[] (balance-sheet quarter&limit=4 응답)  
            - 규칙: 배열의 단순 평균 (값이 없으면 null)  
            - 사용 예: equityAvg = 최근 4분기 평균 자기자본
        - lastFromQuarter  
            - 입력: number[]  
            - 규칙: 배열이 비어 있으면 null, 아니면 values[0] (가장 최근 분기 값)  
            - 사용 예: totalStockholdersEquity(최근 분기), totalDebtLatest, cashAndCashEquivalentsLatest 등
        - avgConsensus  
            - 입력: number[] (adjPriceTarget 값 배열)  
            - 규칙: 단순 평균 (값이 없으면 null)  
            - 사용 예: 컨센서스 목표가 계산
        - ratingAnalyst  
            - 입력: PriceTargetRecord[] (애널리스트별 priceTarget 히스토리)  
            - formula: ratingAnalyst(values, horizons=[0,1,2,3,4,5,6,7,14,21,30,60,180,365])  
            - 설명(개념):
                - 각 레코드 r 에 대해 symbol, publishedDate, priceTarget 를 사용한다.
                - 각 N ∈ {0,1,2,3,4,5,6,7,14,21,30,60,180,365} 에 대해:
                    - dₙ = publishedDate + N일  
                    - P(r, N) = getLastPrice(symbol, dₙ).close  
                        - docs/ApiList.json 의 getQuantitiveValuation.getLastPrice (serviceId = "fmp-historical-price-eod") 사용  
                        - 각 ticker 별로는 가능한 한 한 번만 호출해 전체 히스토리를 가져온 뒤, dₙ 에 해당하는 가격을 로컬에서 조회하는 것을 원칙으로 한다.
                    - D+N 괴리율: gap_N(r) = P(r, N) / priceTarget  
                - analystName 별로 리포트를 그룹화한 뒤, 각 N에 대해:
                    - 평균 괴리율 μ_A(N) = gap_N(r) 의 평균  
                    - 표준편차 σ_A(N) = gap_N(r) 의 표본 표준편차  
                - 결과적으로
                    - analystName: David Williams  
                        - D+0 AVG Gap rate, D+0 deviation  
                        - …  
                        - D+365 AVG Gap rate, D+365 deviation  
                과 같은 형태의 “애널리스트별 D+N 괴리율 프로파일”을 계산하는 데 사용된다.
        - consensusWithAnalystRating  
            - 입력: PriceTargetRecord[] (getEachPriceTargetConsensus 응답 형태)  
            - formula: consensusWithAnalystRating(values)  
            - 설명: getEachPriceTargetConsensus 결과의 각 항목에 대해, 동일한 analystName 의 ratingAnalyst 결과(D+N 평균 괴리율 및 편차)를 병합하기 위한 aggregation 으로 정의되어 있다. (현 시점 evMethod.json 에서는 metric 에서 직접 사용하지 않지만, 향후 확장을 위한 빌딩 블록으로 준비됨)

    3. 방식1: 기업 공시 지표 기반 정량 가치 평가 (metrics.getQuantitiveValuation)  
        - input: docs/getEventCache.json 에 저장되어 있는 ticker (events[*].ticker)
        - 데이터 수집:
            - docs/ApiList.json 파일에서 JSONPath $["getQuantitiveValuation"] 하위의 엔드포인트로 수집할 수 있는 모든 객체를 로드한다.
                - 각 service 노드(예: "service-FMP")의 service.API, service.fieldMap 정의를 사용하여 데이터를 수집한다.
                - fieldMap의 value를 통해 원격 응답 키를 참조하고, key를 통해 내부 로컬필드명(예: "ticker", "revenue")으로 매핑한다.
        - 계산:
            - docs/evMethod.json 파일의 getQuantitiveValuation에 정의된 수식 및 metrics.getQuantitiveValuation 하위의 metric 정의를 따른다.
                - metrics.getQuantitiveValuation.* 항목의 formula에서 사용되는 변수명은 모두 variables 블록에 정의된 serviceId + field + aggregationId 조합을 통해 계산된 값이어야 한다.
            - 평가 방식(정량 지표)에는 다음이 포함된다.
                - PBR, PSR, PER, ROE, EV/EBITDA, RunwayYears, CurrentRatio, CashToRevenueTTM, RevenueYoY, RevenueQoQ, GrossMarginLastQuarter, GrossMarginTTM, RNDIntensityTTM, OperatingMarginTTM, SharesDilutionYoY, DebtToEquityAvg, OtherNonCurrentLiabilitiesToEquityAvg, NetDebtToEquityAvg, APICYoY를 evMethod.json 파일의 정리된 방식으로 계산한다.

    4. 방식2: 컨센서스·애널리스트 기반 정성 가치 평가 (metrics.getQualativeValuation)  
        4-1. 개요
            - input: docs/getEventCache.json 에 저장되어 있는 ticker (events[*].ticker)
            - docs/ApiList.json 의 JSONPath $["getQualativeValuation"] 하위 엔드포인트와 docs/evMethod.json 의 getQualativeValuation 정의를 사용하여, 컨센서스 가격 및 애널리스트 별 가격 목표의 적중도/괴리율을 기반으로 가치 평가를 수행한다.
            - 컨센서스 기반 평가에서 특히 다음 세 가지 축을 다룬다.
                1) ConsensusTargetPrice: 티커별 조정 목표가(adjPriceTarget) 컨센서스
                2) Analyst Rating (D+N Gap): 애널리스트 별 D+N 괴리율 프로파일
                3) EachPriceTargetConsensusWithRating: 특정 티커의 개별 priceTarget 라인에 애널리스트 괴리율 통계를 병합한 정보

        4-2. 사용 API 및 데이터 구조
            - getQualativeValuation.getEachPriceTargetConsensus
                - docs/ApiList.json 의 $["getQualativeValuation"]["getEachPriceTargetConsensus"] 하위 service를 사용한다.
                - 예: service-FMP 의 id = "fmp-price-target"
                - 입력: ticker (예: "RGTI")
                - 출력: PriceTargetRecord[] (컨센서스용 레코드 배열)
                    - 대표 필드(로컬 필드 기준 예시)
                        - ticker (혹은 symbol)
                        - publishedDate
                        - newsURL, newsTitle
                        - analystName
                        - priceTarget, adjPriceTarget, priceWhenPosted
                        - newsPublisher, newsBaseURL
                        - analystCompany
                    - 예시 (input = RGTI 일 때):
                        [
                        {
                            "symbol": "RGTI",
                            "publishedDate": "2025-11-11T21:19:06.000Z",
                            "newsURL": "...",
                            "newsTitle": "...",
                            "analystName": "David Williams",
                            "priceTarget": 40,
                            "adjPriceTarget": 40,
                            "priceWhenPosted": 31.4,
                            "newsPublisher": "TheFly",
                            "newsBaseURL": "thefly.com",
                            "analystCompany": "Williams Trading"
                        },
                        {
                            "symbol": "RGTI",
                            "publishedDate": "2025-11-03T07:35:00.000Z",
                            "newsURL": "...",
                            "newsTitle": "...",
                            "analystName": "Craig Ellis",
                            "priceTarget": 42,
                            "adjPriceTarget": 42,
                            "priceWhenPosted": 44.27,
                            "newsPublisher": "StreetInsider",
                            "newsBaseURL": "streetinsider.com",
                            "analystCompany": "B.Riley Financial"
                        },
                        ...
                        ]
            - getQualativeValuation.analystRating
                - docs/ApiList.json 의 $["getQualativeValuation"]["analystRating"] 하위 service를 사용한다.
                - 예: service-FMP 의 id = "fmp-price-target-analyst-name"
                - 입력: analystName (예: "David Williams")
                - 출력: 해당 애널리스트가 과거에 제시한 모든 priceTarget 히스토리 PriceTargetRecord[]
                    - 필수 필드(로컬 필드 기준):
                        - ticker (symbol)
                        - publishedDate
                        - analystName
                        - priceTarget, adjPriceTarget
                        - priceWhenPosted
                        - 기타 news 관련 필드 등

            - getQuantitiveValuation.getLastPrice
                - docs/ApiList.json 의 $["getQuantitiveValuation"]["getLastPrice"] 하위 service를 사용한다.
                - 예: service-FMP 의 id = "fmp-historical-price-eod"
                - 역할: 특정 ticker, 특정 날짜(또는 날짜 구간)에 대한 종가(close)를 가져와 D+N 괴리율 계산에 사용한다.

        4-3. D+N 괴리율 및 ratingAnalyst 계산 규칙 (docs/evMethod.json 기준)

            - docs/evMethod.json 의 aggregations.ratingAnalyst 정의를 따른다.
                - id: "ratingAnalyst"
                - input: "PriceTargetRecord[]"
                - formula: "ratingAnalyst(values, horizons=[0,1,2,3,4,5,6,7,14,21,30,60,180,365])"
                - description: 애널리스트별 priceTarget의 D+N 괴리율 평균과 표준편차
                    - D+N 괴리율 = getLastPrice(symbol, publishedDate + N).close / priceTarget
                    - 각 ticker별로 fmp-historical-price-eod를 한 번만 호출해서 전체 히스토리를 가져온 뒤, 그 안에서 publishedDate+N에 해당하는 가격을 찾아 사용한다.
                    - 즉, ticker 하나당 1번 호출, N 날짜별 가격은 로컬에서 계산/조회한다.

            - D+N 괴리율 정의
                - 수평선(N) 집합:
                    - N ∈ {0, 1, 2, 3, 4, 5, 6, 7, 14, 21, 30, 60, 180, 365}
                - 각 PriceTargetRecord r 에 대해:
                    - r.symbol: 리포트 대상 ticker
                    - r.publishedDate: 리포트 발행일
                    - r.priceTarget: 목표가
                - D+N 날짜:
                    - dₙ = publishedDate + N일 (기본은 캘린더 날짜 기준. 필요 시 구현에서 휴장일 보정 로직 추가 가능)
                - 가격 P(r, N):
                    - getQuantitiveValuation.getLastPrice (serviceId = "fmp-historical-price-eod")를 사용하여
                    - fromDate = dₙ, toDate = dₙ 에 대한 EOD price(close)를 조회하여 P(r, N)으로 사용한다.
                    - dₙ 날짜에 가격이 없는 경우(휴장 등)에는 구현 규칙에 따라:
                        - 가장 가까운 이전 거래일의 종가를 사용하거나,
                        - 해당 리포트를 해당 N 계산에서 제외하는 등 정책을 사전에 결정한다.
                - D+N 괴리율(ratio):
                    - gap_N(r) = P(r, N) / r.priceTarget
                    - 필요 시 괴리율(%)는 (gap_N(r) - 1) × 100 으로 변환해 해석할 수 있다.

            - 애널리스트별 D+N 평균 괴리율과 표준편차
                - 특정 애널리스트 A의 전체 레코드 집합을 R_A 라고 할 때,
                    - R_A^{(N)} = { r ∈ R_A | P(r, N)를 성공적으로 구한 경우 }
                - 평균 괴리율 μ_A(N):
                    - μ_A(N) = (1 / |R_A^{(N)}|) × Σ_{r ∈ R_A^{(N)}} gap_N(r)
                - 괴리율 표준편차 σ_A(N):
                    - 표본 표준편차 기준 예:
                        - σ_A(N) = sqrt( (1 / (|R_A^{(N)}| - 1)) × Σ_{r ∈ R_A^{(N)}} (gap_N(r) - μ_A(N))² )
                - 구현 결과는 다음과 같은 형태로 요약될 수 있다.
                    - analystName: David Williams
                        - D+0 AVG Gap rate: ...
                        - D+0 deviation: ...
                        - ...
                        - D+365 AVG Gap rate: ...
                        - D+365 deviation: ...

            - docs/evMethod.json 의 metrics.getQualativeValuation.analystRating 정의
                - id: "analystRating"
                - displayName: "Analyst Rating (D+N Gap)"
                - formula: "ratingAnalyst(analystPriceTargets)"
                - variables:
                    - analystPriceTargets:
                        - serviceId: "fmp-price-target-analyst-name"
                        - record: true   // 전체 PriceTargetRecord[]를 ratingAnalyst에 그대로 전달
                        - aggregationId: "ratingAnalyst"

                - getValuation 엔드포인트에서 특정 analystName의 과거 실적(괴리율 패턴)을 요약할 때, 이 metric을 호출하여 사용한다.

        4-4. 컨센서스 한 줄 기준으로 애널리스트 평가 값 병합 (EachPriceTargetConsensusWithRating)

            - 개요
                - 목표: 특정 ticker에 대해 getEachPriceTargetConsensus 로 얻은 각 레코드(한 줄)마다, 해당 analystName의 D+N 괴리율 평균/편차 정보를 함께 제공한다.
                - 예: input = RGTI
                    - 각 라인:
                        - symbol = "RGTI"
                        - publishedDate
                        - analystName = "David Williams" 또는 "Craig Ellis" 등
                        - priceTarget, adjPriceTarget, priceWhenPosted, ...
                    - 각 라인에 대해:
                        - analystName: David Williams
                            - D+0 AVG Gap rate: ...
                            - D+0 deviation: ...
                            - ...
                            - D+365 AVG Gap rate: ...
                            - D+365 deviation: ...
                        - 와 같은 프로파일을 병합

            - docs/evMethod.json 의 aggregations.consensusWithAnalystRating (신규)
                - id: "consensusWithAnalystRating"
                - description: "getEachPriceTargetConsensus 결과의 각 항목에 analystName 기준 ratingAnalyst(D+N 평균 괴리율 및 편차)를 병합"
                - input: "PriceTargetRecord[]"
                - formula: "consensusWithAnalystRating(values)"
                - 구현 규칙(개념):
                    1) values 배열에서 analystName 을 추출하고, unique analystName 집합을 만든다.
                    2) 각 analystName 에 대해:
                        - ApiList.getQualativeValuation.analystRating (fmp-price-target-analyst-name) 호출
                        - docs/evMethod.json.metrics.getQualativeValuation.analystRating (ratingAnalyst aggregation) 적용
                        - 애널리스트별 D+N 괴리율 평균/편차 통계 객체를 얻는다.
                    3) values 의 각 레코드에 대해:
                        - record.analystName 을 키로 위에서 계산한 통계를 찾고,
                        - record.analystRatingStats (또는 동등한 이름의 필드)에 D+N 통계를 병합한다.
                    4) 최종적으로 변환된 레코드 배열을 반환한다.

                - 결과 예시(개념):
                    [
                    {
                        "symbol": "RGTI",
                        "publishedDate": "2025-11-11T21:19:06.000Z",
                        "analystName": "David Williams",
                        "priceTarget": 40,
                        "adjPriceTarget": 40,
                        "priceWhenPosted": 31.4,
                        "...": "...",
                        "analystRatingStats": {
                        "D+0":   { "meanGap": 1.10, "stdGap": 0.282 },
                        "D+1":   { "meanGap": 1.09, "stdGap": 0.300 },
                        "...":   "...",
                        "D+365": { "meanGap": 3.10, "stdGap": 1.3036 }
                        }
                    },
                    {
                        "symbol": "RGTI",
                        "publishedDate": "2025-11-03T07:35:00.000Z",
                        "analystName": "Craig Ellis",
                        "priceTarget": 42,
                        "...": "...",
                        "analystRatingStats": {
                        "D+0":   { "meanGap": ..., "stdGap": ... },
                        "...":   "..."
                        }
                    },
                    ...
                    ]

            - docs/evMethod.json 의 metrics.getQualativeValuation.EachPriceTargetConsensusWithRating (신규)
                - id: "each-price-target-consensus-with-rating"
                - displayName: "Each Price Target Consensus With Analyst Rating"
                - formula: "consensusWithAnalystRating(consensusRecords)"
                - variables:
                    - consensusRecords:
                        - serviceId: "fmp-price-target"  // getEachPriceTargetConsensus
                        - aggregationId: "consensusWithAnalystRating"

                - getValuation 엔드포인트는 티커별 컨센서스 라인에 애널리스트 D+N 괴리율 통계를 결합하고자 할 때, 이 metric을 사용한다.

        4-5. 방식2에서 사용하는 주요 지표 요약
            - ConsensusTargetPrice (docs/evMethod.json.metrics.getQualativeValuation.ConsensusTargetPrice)
                - 각 ticker의 adjPriceTarget 기반 컨센서스 목표가 산출
            - Analyst Rating (D+N Gap) (docs/evMethod.json.metrics.getQualativeValuation.analystRating)
                - 애널리스트별 과거 priceTarget 히스토리에서 D+N 괴리율 평균 및 편차를 계산
                - “이 애널리스트의 목표가는 특정 기간(D+N)에서 얼마나 일관되게/보수적으로/공격적으로 맞춰졌는가?”를 정량화
            - EachPriceTargetConsensusWithRating (docs/evMethod.json.metrics.getQualativeValuation.EachPriceTargetConsensusWithRating)
                - 특정 ticker 의 개별 컨센서스 라인에 대해, 해당 애널리스트의 D+N 괴리율 프로파일을 함께 제공
                - 예시 출력 포맷:
                    - analystName: David Williams
                        - D+0 AVG Gap rate: ...
                        - D+0 deviation: ...
                        - ...
                        - D+365 AVG Gap rate: ...
                        - D+365 deviation: ...

    5. getValuation 엔드포인트에서의 종합 규칙  
        - getValuation 은 다음 순서를 따른다.
            1) docs/getEventCache.json 에서 ticker 목록(events[*].ticker)을 읽어온다.
            2) 각 ticker 에 대해:
                - docs/ApiList.json 의 getQuantitiveValuation 경로에 정의된 엔드포인트를 사용해 재무 데이터를 수집하고, docs/evMethod.json 의 aggregations 및 metrics.getQuantitiveValuation 정의에 따라 PBR, PSR, PER, ROE, EV/EBITDA 등 정량 지표를 계산한다.
                - docs/ApiList.json 의 getQualativeValuation 경로에 정의된 엔드포인트를 사용해 컨센서스/애널리스트 데이터를 수집하고, docs/evMethod.json 의 aggregations 및 metrics.getQualativeValuation 정의에 따라 ConsensusTargetPrice 와 Analyst Rating (D+N Gap)을 계산한다.
            3) 각 ticker 별로 정량 지표 + 정성 지표를 하나의 평가 객체로 병합하여 응답 본문에 포함한다.
        - docs/ApiList.json 의 getQuantitiveValuation, getQualativeValuation 경로에는 향후 엔드포인트가 추가될 수 있으며,
            - getQuantitiveValuation 에는 docs/evMethod.json 의 metrics.getQuantitiveValuation 에서 필요로 하는 공식에 필요한 요소만 추가한다.
            - getQualativeValuation 에는 docs/evMethod.json 의 metrics.getQualativeValuation 및 aggregations.ratingAnalyst / consensusWithAnalystRating 이 필요로 하는 필드만 추가한다.
        - 새로운 엔드포인트나 필드를 추가할 때는 항상
            - docs/ApiList.json 의 service.fieldMap 정의를 먼저 수정한 뒤,
            - docs/evMethod.json 의 metrics / aggregations 정의를 갱신하고,
            - 필요한 경우 getEvent_specify_v2.txt 의 c. 가치 평가 절을 업데이트해야 한다.
