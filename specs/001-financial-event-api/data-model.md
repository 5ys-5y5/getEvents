# Data Model Specification

**Feature**: Financial Event and Valuation API
**Version**: 1.0
**Last Updated**: 2025-11-25

---

## Overview

This document defines the data entities, field types, validation rules, and relationships for the Financial Event and Valuation API system. All entities are designed to support NDJSON streaming, JSON REST responses, and file-based caching mechanisms.

---

## 1. EventRecord

**Purpose**: Represents a single financial event (e.g., earnings calendar entry) for a specific ticker on a specific date.

**Format**: NDJSON line item (one event per line)

**Source**: API responses from services defined in `ApiList.json` under `getEvent.*.*`

### Fields

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| `ticker` | string | Yes | Must exist in `docs/symbolCache.json` | Stock ticker symbol (e.g., "AAPL") |
| `date` | string (ISO 8601) | Yes | Format: YYYY-MM-DD; Must fall within requested startDate~endDate range | Event occurrence date |
| `source` | string | Yes | Must match a `service.id` from `ApiList.json` getEvent section | Data source identifier (e.g., "fmp-earnings-calendar") |

### Additional Fields

Additional fields are dynamically mapped from API responses based on `ApiList.json` service `fieldMap` definitions. The system uses runtime mapping to convert API response keys to local field names.

**Example**:
```json
{
  "ticker": "AAPL",
  "date": "2025-12-01",
  "source": "fmp-earnings-calendar"
}
```

### Validation Rules

- **FR-006**: Records where `ticker` is not present in `docs/symbolCache.json` must be excluded from responses and cache
- **FR-007**: Duplicate records with identical `(ticker, date, source)` combinations must be deduplicated, keeping only the first occurrence
- **FR-028**: Output field set must exactly match `docs/getEventOutputSchema.jsonl` eventRecord.properties definition

### State Transitions

- Created during `getEvent` API call
- Filtered by symbolCache presence
- Deduplicated by (ticker, date, source) key
- Streamed as NDJSON line
- Persisted to `docs/getEventCache.json`

---

## 2. MetaRecord

**Purpose**: Contains metadata about the getEvent execution including generation timestamp, request parameters, and error tracking.

**Format**: Last line of NDJSON stream, single JSON object in cache file

**Source**: Generated by system after processing all API responses

### Fields

| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| `type` | string (literal) | Yes | Must equal "meta" | Record type discriminator |
| `getEvent_generated_at` | string (ISO 8601) | Yes | UTC timestamp format: YYYY-MM-DDTHH:mm:ssZ | Generation timestamp |
| `request` | object | Yes | See Request Object below | Original request parameters |
| `collectionErrorChecklist` | object | Yes | See Error Checklist Object below | API call status tracking |

### Request Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `startDate` | integer | Yes | Original startDate parameter (days offset) |
| `endDate` | integer | Yes | Original endDate parameter (days offset) |
| `fromDate` | string (ISO 8601) | Yes | Computed start date (YYYY-MM-DD) |
| `toDate` | string (ISO 8601) | Yes | Computed end date (YYYY-MM-DD) |

### Collection Error Checklist Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `function` | string | Yes | Function name (e.g., "getEvent") |
| `status` | array of StatusRecord | Yes | Per-service call results |

### StatusRecord

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | Yes | Service ID from `ApiList.json` (e.g., "fmp-earnings-calendar") |
| `success` | boolean | Yes | Whether the service call succeeded |
| `statusCode` | integer | Yes | HTTP status code (e.g., 200, 500) |
| `errorMessage` | string or null | Yes | Error message if failed, null if successful |

**Example**:
```json
{
  "type": "meta",
  "getEvent_generated_at": "2025-11-25T14:30:00Z",
  "request": {
    "startDate": 3,
    "endDate": 7,
    "fromDate": "2025-11-28",
    "toDate": "2025-12-02"
  },
  "collectionErrorChecklist": {
    "function": "getEvent",
    "status": [
      {
        "id": "fmp-earnings-calendar",
        "success": true,
        "statusCode": 200,
        "errorMessage": null
      }
    ]
  }
}
```

### Validation Rules

- **FR-023**: All date calculations must be performed in UTC
- **FR-026**: Missing `FMP_API_KEY` environment variable must result in service failure recorded in status array
- **FR-030**: Partial API failures after HTTP 200 stream start must be recorded in metaRecord

---

## 3. SymbolCache

**Purpose**: Maintains the list of eligible tickers with sector/industry metadata for event filtering.

**Format**: JSON file at `docs/symbolCache.json`

**Source**: Populated from `filter.target` API services defined in `ApiList.json`

### Structure

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `meta` | object | Yes | Cache metadata |
| `meta.symbolCache_generated_at` | string (ISO 8601) | Yes | Cache generation timestamp (UTC) |
| `meta.sources` | array of SourceRecord | Yes | Data source tracking |
| `ticker` | object | Yes | Map of ticker symbols to company info |

### SourceRecord

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | Yes | Service ID (e.g., "fmp-company-screener") |
| `success` | boolean | Yes | Whether the refresh succeeded |
| `statusCode` | integer | Yes | HTTP status code |
| `errorMessage` | string or null | Yes | Error message if failed |

### Ticker Entry

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `sector` | string | No | Company sector |
| `industry` | string | No | Company industry |

**Example**:
```json
{
  "meta": {
    "symbolCache_generated_at": "2025-11-20T10:00:00Z",
    "sources": [
      {
        "id": "fmp-company-screener",
        "success": true,
        "statusCode": 200,
        "errorMessage": null
      }
    ]
  },
  "ticker": {
    "AAPL": {
      "sector": "Technology",
      "industry": "Consumer Electronics"
    },
    "MSFT": {
      "sector": "Technology",
      "industry": "Software"
    }
  }
}
```

### Validation Rules

- **FR-003**: If `meta.symbolCache_generated_at` is more than 7 days old (based on today's UTC date), system must attempt refresh via `filter.target` API
- **FR-004**: Failed refresh attempts must retry up to 3 times; if all fail, use stale cache and record failure in metaRecord
- **FR-006**: Only tickers present in this cache are eligible for inclusion in getEvent results

### State Transitions

- **Fresh** (< 7 days old): Use as-is
- **Stale** (≥ 7 days old): Trigger refresh before getEvent processing
- **Refresh Failed**: Continue with stale data, log error in metaRecord

---

## 4. EventCache

**Purpose**: Stores the most recent successful getEvent result for fast retrieval without re-fetching from external APIs.

**Format**: JSON file at `docs/getEventCache.json`

**Source**: Written by getEvent endpoint on HTTP 200 completion

### Structure

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `meta` | MetaRecord | Yes | Same structure as MetaRecord (Section 2) |
| `events` | array of EventRecord | Yes | Array of event records |

**Example**:
```json
{
  "meta": {
    "type": "meta",
    "getEvent_generated_at": "2025-11-25T14:30:00Z",
    "request": {
      "startDate": 3,
      "endDate": 7,
      "fromDate": "2025-11-28",
      "toDate": "2025-12-02"
    },
    "collectionErrorChecklist": {
      "function": "getEvent",
      "status": [...]
    }
  },
  "events": [
    {
      "ticker": "AAPL",
      "date": "2025-11-28",
      "source": "fmp-earnings-calendar"
    }
  ]
}
```

### Validation Rules

- **FR-008**: Cache must be written upon successful HTTP 200 completion of getEvent
- **FR-010**:
  - Return HTTP 404 if file does not exist (user must run getEvent first)
  - Return HTTP 503 if file exists but cannot be parsed (file corruption)

### State Transitions

- **Not Exists**: Requires initial getEvent call
- **Exists**: Can be retrieved via getEventLatest endpoint
- **Corrupted**: HTTP 503 error, requires new getEvent call

### Usage

- **getEventLatest**: Returns cached content as JSON without modification
- **getValuation (cache=true)**: Reads `meta.request.{startDate, endDate}` to determine date range for internal getEvent refresh

---

## 5. ValuationRecord

**Purpose**: Contains quantitative and qualitative valuation metrics for a single ticker.

**Format**: JSON object element within getValuation response array

**Source**: Computed by system using APIs defined in `ApiList.json` under `getQuantitiveValuation` and `getQualativeValuation`

### Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `ticker` | string | Yes | Stock ticker symbol |
| `quantitive` | QuantitativeMetrics object | Yes | Financial ratio-based metrics |
| `qualitative` | QualitativeMetrics object | Yes | Analyst consensus and rating metrics |
| `date` | string (ISO 8601) | No | Event date (if triggered by cache=true) |
| `source` | string | No | Event source (if triggered by cache=true) |

### QuantitativeMetrics Object

All metrics are nullable (return `null` if insufficient data).

| Metric | Type | Formula | Description |
|--------|------|---------|-------------|
| `PBR` | number or null | marketCap / totalStockholdersEquity | Price to Book Ratio |
| `PSR` | number or null | marketCap / revenueTTM | Price to Sales Ratio |
| `PER` | number or null | marketCap / netIncomeTTM | Price to Earnings Ratio |
| `ROE` | number or null | netIncomeTTM / equityAvg | Return on Equity |
| `EV_EBITDA` | number or null | (marketCap + totalDebtLatest - cashLatest) / ebitdaTTM | Enterprise Value to EBITDA |
| `RunwayYears` | number or null | cashAndSTI / abs(operatingIncomeTTM) if operatingIncomeTTM < 0, else null | Years until cash depletion |
| `CurrentRatio` | number or null | totalCurrentAssets / totalCurrentLiabilities | Liquidity ratio |
| `CashToRevenueTTM` | number or null | cashAndSTI / revenueTTM | Cash coverage ratio |
| `RevenueYoY` | number or null | (revenueLast - revenueYearAgo) / revenueYearAgo | Year-over-year growth |
| `RevenueQoQ` | number or null | (revenueLast - revenueLastQuarter) / revenueLastQuarter | Quarter-over-quarter growth |
| `GrossMarginLastQuarter` | number or null | grossProfitLast / revenueLast | Latest quarter gross margin |
| `GrossMarginTTM` | number or null | grossProfitTTM / revenueTTM | TTM gross margin |
| `RNDIntensityTTM` | number or null | rndTTM / revenueTTM | R&D spending intensity |
| `OperatingMarginTTM` | number or null | operatingIncomeTTM / revenueTTM | Operating margin |
| `SharesDilutionYoY` | number or null | (sharesLast - sharesYearAgo) / sharesYearAgo | Share dilution rate |
| `DebtToEquityAvg` | number or null | avgTotalDebt / avgTotalEquity | Debt to equity ratio |
| `OtherNonCurrentLiabilitiesToEquityAvg` | number or null | avgOtherNCL / avgTotalEquity | Other liabilities ratio |
| `NetDebtToEquityAvg` | number or null | avgNetDebt / avgTotalEquity | Net debt to equity ratio |
| `APICYoY` | number or null | (apicLast - apicYearAgo) / apicYearAgo | Additional paid-in capital growth |

### QualitativeMetrics Object

| Metric | Type | Description |
|--------|------|-------------|
| `ConsensusTargetPrice` | number or null | Average of all adjPriceTarget values from fmp-price-target |
| `analystRating` | object or null | Map of analystName to AnalystRatingProfile |
| `PriceTargetSummary` | object or null | Pass-through of first element from fmp-price-target-summary API |
| `EachPriceTargetConsensusWithRating` | array of PriceTargetWithRating | Each price target record merged with analyst D+N statistics |

### AnalystRatingProfile

| Field | Type | Description |
|-------|------|-------------|
| `analystName` | string | Analyst name |
| `D+0` | object or null | Same-day gap statistics |
| `D+1` | object or null | Next-day gap statistics |
| `D+7` | object or null | 7-day gap statistics |
| `D+14` | object or null | 14-day gap statistics |
| `D+30` | object or null | 30-day gap statistics |
| `D+60` | object or null | 60-day gap statistics |
| `D+180` | object or null | 180-day gap statistics |
| `D+365` | object or null | 365-day gap statistics |

Each D+N object contains:

| Field | Type | Description |
|-------|------|-------------|
| `avgGapRate` | number | Average (EOD price at publishedDate+N) / priceTarget |
| `deviation` | number | Standard deviation of gap rates |
| `sampleCount` | integer | Number of historical predictions used |

**Example**:
```json
{
  "ticker": "AAPL",
  "quantitive": {
    "PBR": 45.2,
    "PSR": 7.8,
    "PER": 28.5,
    "ROE": 0.47,
    "EV_EBITDA": 22.3,
    "RunwayYears": null,
    "CurrentRatio": 1.05
  },
  "qualitative": {
    "ConsensusTargetPrice": 185.50,
    "analystRating": {
      "David Williams": {
        "D+7": {
          "avgGapRate": 1.02,
          "deviation": 0.05,
          "sampleCount": 12
        }
      }
    },
    "PriceTargetSummary": {
      "lastMonthAvgPriceTarget": 180.00,
      "lastQuarterAvgPriceTarget": 175.00
    }
  }
}
```

### Validation Rules

- **FR-014**: Quantitative metrics calculated per `docs/evMethod.json` definitions
- **FR-015**: TTM aggregation uses sum if 4 quarters available, else (average * 4)
- **FR-016**: Qualitative metrics calculated per `docs/evMethod.json` definitions
- **FR-017**: Analyst rating must compute D+N gap rate average and standard deviation
- **FR-018**: Each of 14 D+N horizons (0,1,2,3,4,5,6,7,14,21,30,60,180,365) requires separate fmp-historical-price-eod API call
- **FR-019**: If D+N date falls on non-trading day, use most recent prior trading day's EOD price
- **FR-020**: Omit D+N fields where sample count < 3
- **FR-022**: PriceTargetSummary is pass-through of first API response element or null if empty

---

## 6. PriceTargetRecord

**Purpose**: Represents a single analyst's price target prediction at a specific point in time.

**Format**: JSON object from API responses (fmp-price-target, fmp-price-target-analyst-name)

### Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `ticker` | string | Yes | Stock ticker symbol |
| `publishedDate` | string (ISO 8601) | Yes | Date the price target was published |
| `analystName` | string | Yes | Name of the analyst |
| `priceTarget` | number | Yes | Original price target |
| `adjPriceTarget` | number | Yes | Split-adjusted price target |
| `priceWhenPosted` | number | No | Stock price when target was posted |
| `newsURL` | string | No | URL to news article |
| `newsTitle` | string | No | Article title |
| `newsPublisher` | string | No | Publisher name |
| `newsBaseURL` | string | No | Base URL of publisher |
| `analystCompany` | string | No | Analyst's company/firm |

**Example**:
```json
{
  "ticker": "RGTI",
  "publishedDate": "2025-11-01",
  "analystName": "David Williams",
  "priceTarget": 15.00,
  "adjPriceTarget": 15.00,
  "priceWhenPosted": 12.50,
  "analystCompany": "Example Capital"
}
```

### Usage

- **ConsensusTargetPrice**: Average of all `adjPriceTarget` values
- **analystRating**: Group by `analystName`, calculate D+N gap rates using historical EOD prices
- **EachPriceTargetConsensusWithRating**: Merge individual records with analyst's D+N profile

---

## 7. PriceTargetWithRating

**Purpose**: Enhanced price target record that includes the analyst's historical accuracy profile.

**Format**: Element in `EachPriceTargetConsensusWithRating` array

### Fields

Inherits all fields from PriceTargetRecord, plus:

| Field | Type | Description |
|-------|------|-------------|
| `analystRating` | AnalystRatingProfile | D+N gap statistics for this analyst with statistical confidence metrics |

**Example**:
```json
{
  "ticker": "RGTI",
  "publishedDate": "2025-11-01",
  "analystName": "David Williams",
  "priceTarget": 15.00,
  "adjPriceTarget": 15.00,
  "analystRating": {
    "D7": {
      "meanGapRate": 0.0042,
      "stdGapRate": 0.067,
      "count": 8,
      "standardError": 0.0237,
      "ci95Lower": -0.0422,
      "ci95Upper": 0.0506,
      "ci95Width": 0.0928
    },
    "D30": {
      "meanGapRate": 0.3939,
      "stdGapRate": 0.7991,
      "count": 17,
      "standardError": 0.1938,
      "ci95Lower": 0.0140,
      "ci95Upper": 0.7738,
      "ci95Width": 0.7597
    }
  }
}
```

**Gap Rate Statistics Fields**:
- `meanGapRate`: Average gap rate = mean((D+N price / priceWhenPosted) - 1)
- `stdGapRate`: Standard deviation of gap rates (measures prediction volatility)
- `count`: Number of valid samples used for calculation
- `standardError`: Standard error of the mean = stdGapRate / √count
- `ci95Lower`: Lower bound of 95% confidence interval = mean - 1.96×SE
- `ci95Upper`: Upper bound of 95% confidence interval = mean + 1.96×SE
- `ci95Width`: Width of 95% confidence interval = 2 × 1.96 × SE

### Validation Rules

- **FR-021**: Each price target record must be merged with corresponding analystName's D+N statistics

---

## 8. ApiServiceDefinition

**Purpose**: Defines an external API endpoint configuration including URL template and field mapping.

**Format**: JSON object in `docs/ApiList.json`

**Source**: Configuration file maintained by developers

### Structure

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | Yes | Unique service identifier (e.g., "fmp-earnings-calendar") |
| `API` | string | Yes | URL template with placeholders {ticker}, {fromDate}, {toDate}, {fmpApiKey}, {ANALYST_NAME} |
| `fieldMap` | object | Yes | Mapping of local field names (keys) to API response keys (values) |

**Example**:
```json
{
  "id": "fmp-earnings-calendar",
  "API": "https://financialmodelingprep.com/stable/earnings-calendar?from={fromDate}&to={toDate}&apikey={fmpApiKey}",
  "fieldMap": {
    "ticker": "symbol",
    "date": "date"
  }
}
```

### Validation Rules

- **FR-024**: System must convert startDate/endDate to ISO 8601 format and bind to {fromDate}/{toDate}
- **FR-025**: {fmpApiKey} placeholder must be replaced with FMP_API_KEY environment variable
- **FR-026**: Missing FMP_API_KEY must result in service call failure
- **FR-027**: fieldMap must be processed using generalized loop (no hardcoded key names)

### Usage

- **getEvent**: Iterate through all services under `ApiList["getEvent"]`
- **getQuantitiveValuation**: Call services defined under this section
- **getQualativeValuation**: Call services defined under this section
- **filter.target**: Used to refresh symbolCache

---

## Cross-Entity Relationships

### Entity Relationship Diagram

```
┌─────────────────┐
│  ApiList.json   │
└────────┬────────┘
         │ defines services for
         ▼
┌─────────────────┐         refreshes        ┌──────────────────┐
│ SymbolCache     │◄──────────────────────────│ filter.target    │
│ (symbolCache    │                           │ API              │
│  .json)         │                           └──────────────────┘
└────────┬────────┘
         │ filters
         ▼
┌─────────────────┐         writes to         ┌──────────────────┐
│  EventRecord    │───────────────────────────►│  EventCache      │
│  (NDJSON line)  │                            │  (getEventCache  │
└─────────────────┘                            │   .json)         │
         │                                     └────────┬─────────┘
         │ accompanied by                              │
         ▼                                             │
┌─────────────────┐                                   │
│  MetaRecord     │                                   │
│  (last NDJSON   │                                   │
│   line)         │                                   │
└─────────────────┘                                   │
                                                      │ provides tickers for
                                                      ▼
                                           ┌──────────────────┐
                                           │ ValuationRecord  │
                                           │ (getValuation    │
                                           │  response)       │
                                           └────────┬─────────┘
                                                    │ contains
                                                    ▼
                              ┌─────────────────────┴──────────────────────┐
                              ▼                                            ▼
                 ┌─────────────────────────┐                  ┌────────────────────┐
                 │ QuantitativeMetrics     │                  │ QualitativeMetrics │
                 │ (PBR, PSR, PER, etc.)   │                  │ (ConsensusTarget,  │
                 └─────────────────────────┘                  │  analystRating)    │
                                                              └──────────┬─────────┘
                                                                         │ composed of
                                                                         ▼
                                                              ┌────────────────────┐
                                                              │ PriceTargetRecord  │
                                                              │ + AnalystRating    │
                                                              │   Profile          │
                                                              └────────────────────┘
```

### Key Relationships

1. **SymbolCache → EventRecord**: Only tickers in SymbolCache are eligible for EventRecords
2. **EventRecord + MetaRecord → EventCache**: Together form the cached getEvent result
3. **EventCache → ValuationRecord**: When `cache=true`, EventCache provides ticker list for valuation
4. **ApiServiceDefinition → All Records**: Defines how to fetch and map external API data
5. **PriceTargetRecord → AnalystRatingProfile**: Analyst history used to compute D+N statistics
6. **AnalystRatingProfile → PriceTargetWithRating**: Rating profile merged into consensus records

---

## Aggregation Formulas

Referenced from `docs/evMethod.json`:

### ttmFromQuarterSumOrScaled

**Purpose**: Convert quarterly financial data to trailing twelve months (TTM)

**Logic**:
- If 4 quarters available: `sum(values)`
- If < 4 quarters: `(sum(values) / count) * 4`
- If 0 quarters: `null`

**Usage**: revenue, netIncome, ebitda, grossProfit, etc.

### avgFromQuarter

**Purpose**: Calculate average of quarterly values

**Logic**: `sum(values) / count` or `null` if empty

**Usage**: totalStockholdersEquity (for ROE), balance sheet averages

### lastFromQuarter

**Purpose**: Use most recent quarter value

**Logic**: `values[0]` or `null` if empty

**Usage**: Latest balance sheet items

### yoyFromQuarter

**Purpose**: Year-over-year growth rate

**Logic**: `(values[0] - values[3]) / values[3]` or `null` if < 4 quarters

**Usage**: Revenue growth, dilution tracking

### qoqFromQuarter

**Purpose**: Quarter-over-quarter growth rate

**Logic**: `(values[0] - values[1]) / values[1]` or `null` if < 2 quarters

**Usage**: Sequential growth analysis

### avgConsensus

**Purpose**: Simple average of analyst price targets

**Logic**: `sum(adjPriceTarget) / count` or `null` if empty

**Usage**: ConsensusTargetPrice

### ratingAnalyst

**Purpose**: Calculate D+N gap rate statistics for analyst predictions

**Horizons**: [0, 1, 2, 3, 4, 5, 6, 7, 14, 21, 30, 60, 180, 365] days

**Logic**:
1. For each historical priceTarget by analyst:
   - For each horizon N:
     - Fetch EOD price at publishedDate+N (or nearest prior trading day)
     - Calculate gap rate: `EOD_price / priceTarget`
2. For each horizon N:
   - If sample count ≥ 3:
     - Compute avgGapRate (mean)
     - Compute deviation (standard deviation)
   - Else: Omit D+N field

**API Calls**:
- **Per ticker**: 1 call to fmp-historical-price-eod for full history
- **Per horizon**: Local calculation from cached history
- **Total**: 14 lookups per analyst per ticker (local operations after initial fetch)

### consensusWithAnalystRating

**Purpose**: Merge analyst rating profiles into consensus records

**Logic**: For each record in getEachPriceTargetConsensus, lookup analystRating by analystName and merge D+N statistics

---

## Cache Expiry and Refresh Logic

### SymbolCache Expiry

**Trigger**: `meta.symbolCache_generated_at` is ≥ 7 days old

**Process**:
1. Compare current UTC date with `symbolCache_generated_at`
2. If age ≥ 7 days:
   - Call `filter.target` API service
   - Retry up to 3 times on failure
   - If all retries fail:
     - Use stale cache
     - Record failure in metaRecord.collectionErrorChecklist
3. Update `meta.symbolCache_generated_at` on successful refresh

**Reference**: FR-003, FR-004

### EventCache Refresh

**Trigger**: User calls `getValuation?cache=true`

**Process**:
1. Read `docs/getEventCache.json`
2. Extract `meta.request.startDate` and `meta.request.endDate`
3. Call internal `getEvent` with those parameters
4. Overwrite `docs/getEventCache.json` with new results
5. Use `events[*].ticker` as valuation target list

**Fallback**: If getEvent internal call fails, attempt to use stale cache and log error

**Reference**: FR-013, Clarification Q1

---

## Error Handling

### HTTP Status Code Usage

| Scenario | Status Code | Response Format |
|----------|-------------|-----------------|
| Valid getEvent request | 200 | NDJSON stream (EventRecord* + MetaRecord) |
| Invalid date range (startDate > endDate) | 400 | JSON error object |
| Missing required query parameter | 400 | JSON error object |
| getEventCache.json not found | 404 | JSON error object with "GET_EVENT_CACHE_NOT_AVAILABLE" |
| getEventCache.json parse error | 503 | JSON error object |
| All core services failed | 5xx | JSON error object (no NDJSON) |
| Partial API failure after stream start | 200 | NDJSON with errors in metaRecord |

**Reference**: FR-010, FR-029, FR-030, Clarification Q2

### collectionErrorChecklist Structure

Always included in MetaRecord to track per-service call status:

```json
{
  "function": "getEvent",
  "status": [
    {
      "id": "fmp-earnings-calendar",
      "success": true,
      "statusCode": 200,
      "errorMessage": null
    },
    {
      "id": "fmp-company-screener",
      "success": false,
      "statusCode": 401,
      "errorMessage": "Invalid API key"
    }
  ]
}
```

---

## Performance Constraints

### Response Time Targets

| Operation | Target | Notes |
|-----------|--------|-------|
| getEvent NDJSON stream start | < 2 seconds | FR-SC-001 |
| symbolCache refresh (30k tickers) | < 5 seconds | FR-SC-002 |
| getEventLatest (1MB cache) | < 100ms | FR-SC-003 |
| getValuation single ticker | 15-20 seconds | FR-SC-004, includes multiple sequential API calls |
| ratingAnalyst (100 analysts) | < 15 seconds | FR-SC-005, includes 14 D+N calculations per analyst |

### Concurrency

- System must handle 10 concurrent getEvent requests with < 1% error rate (SC-010)

---

## Data Persistence

### File Locations

All file paths are relative to server working directory (supports Render.com deployment):

| File | Path | Purpose | Update Frequency |
|------|------|---------|------------------|
| ApiList.json | `docs/ApiList.json` | API service definitions | Manual (developer config) |
| symbolCache.json | `docs/symbolCache.json` | Eligible ticker list | Auto-refresh if > 7 days old |
| getEventCache.json | `docs/getEventCache.json` | Last getEvent result | Every successful getEvent call |
| evMethod.json | `docs/evMethod.json` | Valuation calculation formulas | Manual (developer config) |
| getEventOutputSchema.jsonl | `docs/getEventOutputSchema.jsonl` | Output schema definition | Manual (developer config) |

**Reference**: FR-009, SC-009

---

## Validation Summary

### Required Validations by Entity

**EventRecord**:
- ✓ ticker must exist in symbolCache
- ✓ date must be YYYY-MM-DD format within requested range
- ✓ (ticker, date, source) must be unique (deduplicate)
- ✓ Output fields must match getEventOutputSchema.jsonl

**MetaRecord**:
- ✓ type must equal "meta"
- ✓ getEvent_generated_at must be UTC ISO 8601
- ✓ All dates must be calculated in UTC
- ✓ collectionErrorChecklist must include all service call results

**SymbolCache**:
- ✓ Refresh if > 7 days old
- ✓ Retry refresh up to 3 times
- ✓ Record refresh failures in metaRecord

**ValuationRecord**:
- ✓ Quantitative metrics follow evMethod.json formulas
- ✓ TTM uses sum if 4 quarters, else (avg * 4)
- ✓ D+N statistics omit entries with < 3 samples
- ✓ All 14 D+N horizons calculated separately
- ✓ Non-trading days use nearest prior trading day

**ApiServiceDefinition**:
- ✓ fieldMap processed via generalized loop (no hardcoded keys)
- ✓ {fmpApiKey} replaced with environment variable
- ✓ Date placeholders use ISO 8601 format

---

## Glossary

| Term | Definition |
|------|------------|
| TTM | Trailing Twelve Months - sum or annualized value of last 4 quarters |
| EOD | End of Day - closing price for a trading day |
| D+N | publishedDate plus N days - used for gap rate calculation |
| Gap Rate | Ratio of actual EOD price to analyst's priceTarget at horizon N |
| NDJSON | Newline-Delimited JSON - one JSON object per line |
| Consensus | Average of multiple analyst price targets |
| adjPriceTarget | Price target adjusted for stock splits |
| fieldMap | Mapping configuration from API response keys to local field names |

---

## References

- **FR-XXX**: Functional Requirements from spec.md
- **SC-XXX**: Success Criteria from spec.md
- **Clarification QX**: Answered clarification questions from spec.md
- **docs/ApiList.json**: API service definitions
- **docs/evMethod.json**: Valuation calculation formulas
- **docs/getEventOutputSchema.jsonl**: Output schema definition
